<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Landscape-optimized viewport for mobile -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- iOS PWA settings - landscape orientation -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Thaasbai">
    <meta name="apple-mobile-web-app-orientations" content="landscape">

    <!-- Android PWA settings -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#001825">
    <meta name="msapplication-navbutton-color" content="#001825">
    <meta name="msapplication-TileColor" content="#001825">

    <!-- Screen orientation hint -->
    <meta name="screen-orientation" content="landscape">
    <meta name="x5-orientation" content="landscape">
    <meta name="x5-fullscreen" content="true">

    <!-- Prevent text size adjustment -->
    <meta name="format-detection" content="telephone=no">

    <!-- iOS icons -->
    <link rel="apple-touch-icon" href="icons/icon-180x180.png">
    <link rel="apple-touch-icon" sizes="120x120" href="icons/icon-120x120.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-167x167.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180x180.png">
    <link rel="apple-touch-icon-precomposed" href="icons/icon-180x180.png">

    <!-- Safari Pinned Tab Icon -->
    <link rel="mask-icon" href="icons/icon.svg" color="#006994">

    <!-- Standard favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png">

    <!-- Splash screens for iOS (landscape orientation) -->
    <!-- iPhone 15 Pro Max -->
    <link rel="apple-touch-startup-image" href="splash/splash-iphone-15-pro-max-2796x1290.png" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <!-- iPhone 14/13/12 -->
    <link rel="apple-touch-startup-image" href="splash/splash-iphone-14-13-12-2532x1170.png" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <!-- iPhone 11 Pro/X -->
    <link rel="apple-touch-startup-image" href="splash/splash-iphone-11-pro-x-2436x1125.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <!-- iPhone 11/XR -->
    <link rel="apple-touch-startup-image" href="splash/splash-iphone-11-xr-1792x828.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <!-- iPhone SE/8 -->
    <link rel="apple-touch-startup-image" href="splash/splash-iphone-se-8-1334x750.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <!-- iPad Pro 12.9" -->
    <link rel="apple-touch-startup-image" href="splash/splash-ipad-pro-12.9-2732x2048.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <!-- iPad Pro 11" -->
    <link rel="apple-touch-startup-image" href="splash/splash-ipad-pro-11-2388x1668.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <!-- iPad Air -->
    <link rel="apple-touch-startup-image" href="splash/splash-ipad-air-2360x1640.png" media="(device-width: 820px) and (device-height: 1180px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <!-- iPad 10.2" -->
    <link rel="apple-touch-startup-image" href="splash/splash-ipad-10.2-2160x1620.png" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <!-- iPad mini -->
    <link rel="apple-touch-startup-image" href="splash/splash-ipad-mini-2266x1488.png" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <!-- iPad 9.7" -->
    <link rel="apple-touch-startup-image" href="splash/splash-ipad-9.7-2048x1536.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">

    <title>Thaasbai - Maldivian Card Games</title>
    <link rel="stylesheet" href="css/base.css?v=2">

    <!-- Service Worker Registration with Auto-Update -->
    <script>
        // Register service worker for PWA with update checking
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('ServiceWorker registered:', registration.scope);

                        // Check for updates on every page load
                        registration.update();

                        // Check for updates periodically (every 5 minutes)
                        setInterval(() => {
                            registration.update();
                        }, 5 * 60 * 1000);

                        // Handle updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('New service worker installing...');

                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available, reload to activate
                                    console.log('New version available, reloading...');
                                    window.location.reload();
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed:', error);
                    });

                // Listen for messages from service worker
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data.type === 'SW_UPDATED') {
                        console.log('Service worker updated to v' + event.data.version);
                        // Optionally reload or notify user
                    }
                });

                // Handle controller change (new SW took over)
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('New service worker activated, reloading...');
                    window.location.reload();
                });
            });
        }

        // Lock screen orientation to landscape
        function lockLandscape() {
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('landscape').catch(() => {
                    // Orientation lock not supported or denied
                    console.log('Orientation lock not available');
                });
            }
        }

        // Try to lock on load and fullscreen
        document.addEventListener('DOMContentLoaded', lockLandscape);
        document.addEventListener('fullscreenchange', lockLandscape);
        document.addEventListener('webkitfullscreenchange', lockLandscape);
    </script>
</head>
<body>
    <!-- Full-screen background that fills viewport regardless of game scale -->
    <div id="game-background"></div>

    <div id="viewport-wrapper">
    <!-- Game Selection Screen -->
    <div id="lobby-overlay" class="game-selection-page">
        <div id="lobby-content">
            <div id="game-selection">
                <h2 class="lobby-title">Thaasbai</h2>
                <p class="lobby-subtitle">Maldivian Card Games</p>

                <div class="game-cards">
                    <div class="game-card" data-game="dhiha-ei">
                        <div class="game-card-icon">&#127183;</div>
                        <h3 class="game-card-title">Dhiha Ei</h3>
                        <p class="game-card-desc">Classic trick-taking game for 4 players in teams</p>
                        <button class="game-select-btn" onclick="window.location.href='dhiha-ei.html'">Play</button>
                    </div>
                    <div class="game-card" data-game="digu">
                        <div class="game-card-icon">&#127156;</div>
                        <h3 class="game-card-title">Digu</h3>
                        <p class="game-card-desc">Rummy-style card matching game (2-4 players)</p>
                        <button class="game-select-btn" onclick="window.location.href='digu.html'">Play</button>
                    </div>
                    <div class="game-card coming-soon" data-game="bondi">
                        <div class="coming-soon-badge">Coming Soon</div>
                        <div class="game-card-icon">&#127919;</div>
                        <h3 class="game-card-title">Bondi</h3>
                        <p class="game-card-desc">Traditional Maldivian card game</p>
                        <button class="game-select-btn" disabled>Coming Soon</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rotate Device Overlay (portrait mode on mobile) -->
    <div id="rotate-overlay">
        <div class="rotate-content">
            <div class="rotate-icon">
                <svg viewBox="0 0 100 100" width="80" height="80">
                    <rect x="25" y="10" width="50" height="80" rx="5" fill="none" stroke="#40E0D0" stroke-width="3"/>
                    <circle cx="50" cy="80" r="4" fill="#40E0D0"/>
                    <path d="M75 50 L90 50 L82.5 35 Z" fill="#FFD700"/>
                    <path d="M90 50 Q95 50 95 55 L95 75 Q95 80 90 80 L75 80" fill="none" stroke="#FFD700" stroke-width="3"/>
                </svg>
            </div>
            <h2>Rotate Your Device</h2>
            <p>Thaasbai is best played in landscape mode</p>
            <button id="play-portrait-btn" class="rotate-dismiss-btn">Play in Portrait Anyway</button>
        </div>
    </div>

    <!-- Install PWA Prompt -->
    <div id="install-prompt" class="hidden">
        <div class="install-content">
            <span>Install Thaasbai for the best experience</span>
            <button id="install-btn" class="install-btn">Install</button>
            <button id="install-dismiss" class="install-dismiss">&times;</button>
        </div>
    </div>

    <!-- PWA Install Handler -->
    <script>
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Show install prompt after a delay
            setTimeout(() => {
                const prompt = document.getElementById('install-prompt');
                if (prompt && !localStorage.getItem('pwaInstallDismissed')) {
                    prompt.classList.remove('hidden');
                }
            }, 3000);
        });

        document.getElementById('install-btn')?.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('Install prompt outcome:', outcome);
                deferredPrompt = null;
            }
            document.getElementById('install-prompt')?.classList.add('hidden');
        });

        document.getElementById('install-dismiss')?.addEventListener('click', () => {
            document.getElementById('install-prompt')?.classList.add('hidden');
            localStorage.setItem('pwaInstallDismissed', 'true');
        });

        // Hide install prompt if already installed
        if (window.matchMedia('(display-mode: standalone)').matches) {
            const prompt = document.getElementById('install-prompt');
            if (prompt) prompt.classList.add('hidden');
        }

        // Handle rotate overlay dismiss
        document.getElementById('play-portrait-btn')?.addEventListener('click', () => {
            document.getElementById('rotate-overlay')?.classList.add('dismissed');
            localStorage.setItem('rotateOverlayDismissed', 'true');
        });

        // Check if rotate overlay was previously dismissed
        if (localStorage.getItem('rotateOverlayDismissed')) {
            document.getElementById('rotate-overlay')?.classList.add('dismissed');
        }
    </script>
    </div><!-- end viewport-wrapper -->
</body>
</html>
