<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Landscape-optimized viewport for mobile -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- iOS PWA settings - landscape orientation -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dhiha Ei">
    <meta name="apple-mobile-web-app-orientations" content="landscape">

    <!-- Android PWA settings -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#001825">
    <meta name="msapplication-navbutton-color" content="#001825">
    <meta name="msapplication-TileColor" content="#001825">

    <!-- Screen orientation hint -->
    <meta name="screen-orientation" content="landscape">
    <meta name="x5-orientation" content="landscape">
    <meta name="x5-fullscreen" content="true">

    <!-- Prevent text size adjustment -->
    <meta name="format-detection" content="telephone=no">

    <!-- iOS icons -->
    <link rel="apple-touch-icon" href="icons/icon-180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-167.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png">

    <!-- Standard favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16.png">

    <!-- Splash screens for iOS -->
    <link rel="apple-touch-startup-image" href="splash/splash-2048x2732.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="splash/splash-1668x2388.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="splash/splash-1536x2048.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="splash/splash-1125x2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="splash/splash-1242x2688.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="splash/splash-1290x2796.png" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">

    <title>Dhiha Ei - Maldivian Card Game</title>
    <link rel="stylesheet" href="css/styles.css">

    <!-- Socket.IO for multiplayer -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <!-- Service Worker Registration -->
    <script>
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('ServiceWorker registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }

        // Lock screen orientation to landscape
        function lockLandscape() {
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('landscape').catch(() => {
                    // Orientation lock not supported or denied
                    console.log('Orientation lock not available');
                });
            }
        }

        // Try to lock on load and fullscreen
        document.addEventListener('DOMContentLoaded', lockLandscape);
        document.addEventListener('fullscreenchange', lockLandscape);
        document.addEventListener('webkitfullscreenchange', lockLandscape);
    </script>
</head>
<body>
    <div id="game-container">
        <header id="game-header">
            <h1>Dhiha Ei</h1>
            <div id="game-status">
                <span id="superior-suit-display">Superior Suit: None</span>
            </div>
        </header>

        <main id="game-board">
            <!-- Match Points Display -->
            <div id="match-points-panel">
                <div class="match-title">Match Score (First to 7)</div>
                <div class="match-scores">
                    <span class="match-score you">You: <span id="match-points-0">0</span></span>
                    <span class="match-score opp">Opp: <span id="match-points-1">0</span></span>
                </div>
                <div class="win-types-breakdown">
                    <div class="win-type-row">
                        <span class="win-type-label">Normal:</span>
                        <span class="win-type-you" id="normal-0">0</span>
                        <span class="win-type-sep">-</span>
                        <span class="win-type-opp" id="normal-1">0</span>
                    </div>
                    <div class="win-type-row">
                        <span class="win-type-label">All 10s:</span>
                        <span class="win-type-you" id="all-tens-0">0</span>
                        <span class="win-type-sep">-</span>
                        <span class="win-type-opp" id="all-tens-1">0</span>
                    </div>
                    <div class="win-type-row">
                        <span class="win-type-label">Shutout:</span>
                        <span class="win-type-you" id="shutout-0">0</span>
                        <span class="win-type-sep">-</span>
                        <span class="win-type-opp" id="shutout-1">0</span>
                    </div>
                </div>
            </div>

            <!-- Round Score displays -->
            <div id="score-panel">
                <div class="round-label">Current Round</div>
                <div class="team-score" id="team0-score">
                    <span class="team-label">Your Team</span>
                    <span class="tens-count">10s: <span id="team0-tens">0</span></span>
                    <span class="tricks-count">Tricks: <span id="team0-tricks">0</span></span>
                    <div class="collected-tens" id="collected-tens-0"></div>
                </div>
                <div class="team-score" id="team1-score">
                    <span class="team-label">Opponent Team</span>
                    <span class="tens-count">10s: <span id="team1-tens">0</span></span>
                    <span class="tricks-count">Tricks: <span id="team1-tricks">0</span></span>
                    <div class="collected-tens" id="collected-tens-1"></div>
                </div>
            </div>

            <!-- Player areas -->
            <div id="player-top" class="player-area partner">
                <div class="player-label">Partner</div>
                <div class="player-hand" id="hand-top"></div>
            </div>

            <div id="player-left" class="player-area opponent">
                <div class="player-label">Opponent</div>
                <div class="player-hand" id="hand-left"></div>
            </div>

            <div id="player-right" class="player-area opponent">
                <div class="player-label">Opponent</div>
                <div class="player-hand" id="hand-right"></div>
            </div>

            <!-- Center play area -->
            <div id="play-area">
                <div id="trick-cards">
                    <div class="played-card" id="played-top"></div>
                    <div class="played-card" id="played-left"></div>
                    <div class="played-card" id="played-right"></div>
                    <div class="played-card" id="played-bottom"></div>
                </div>
                <div id="turn-indicator"></div>
            </div>

            <!-- Human player area -->
            <div id="player-bottom" class="player-area human">
                <div class="player-hand" id="hand-bottom"></div>
                <div class="player-label">You</div>
            </div>
        </main>

        <!-- Game messages and overlays -->
        <div id="message-overlay" class="hidden">
            <div id="message-content">
                <h2 id="message-title"></h2>
                <p id="message-text"></p>
                <button id="message-button">Continue</button>
            </div>
        </div>

        <!-- New game button -->
        <div id="controls">
            <button id="menu-btn">Menu</button>
            <button id="new-game-btn">New Game</button>
        </div>

        <!-- Maldivian Table Items -->
        <div class="table-item chips" id="table-coconut">
            <div class="item-body"></div>
            <div class="item-label">KURUMBA</div>
        </div>
        <div class="table-item drink" id="table-gulha">
            <div class="item-body"></div>
            <div class="item-label">GULHA</div>
        </div>
        <div class="table-item energy" id="table-roshi">
            <div class="item-body"></div>
            <div class="item-label">ROSHI</div>
        </div>
    </div>

    <!-- Lobby Overlay -->
    <div id="lobby-overlay">
        <div id="lobby-content">
            <h2 class="lobby-title">Dhiha Ei</h2>
            <p class="lobby-subtitle">Maldivian Card Game</p>

            <!-- Main Menu -->
            <div id="lobby-menu">
                <button id="play-ai-btn" class="lobby-btn primary">Play vs AI</button>
                <div class="lobby-divider"><span>or play online</span></div>
                <button id="quick-match-btn" class="lobby-btn primary">Quick Match</button>
                <button id="create-room-btn" class="lobby-btn">Create Private Room</button>
                <div class="join-section">
                    <input type="text" id="room-code-input" placeholder="Room Code" maxlength="6" autocomplete="off">
                    <button id="join-room-btn" class="lobby-btn">Join</button>
                </div>
            </div>

            <!-- Matchmaking Queue -->
            <div id="matchmaking-screen" class="hidden">
                <div class="matchmaking-content">
                    <h3>Finding Players...</h3>
                    <div class="matchmaking-spinner"></div>
                    <div class="matchmaking-status">
                        <span id="queue-count">0</span> / 4 players
                    </div>
                    <p class="matchmaking-hint">Game will start automatically when 4 players join</p>
                    <button id="cancel-queue-btn" class="lobby-btn secondary">Cancel</button>
                </div>
            </div>

            <!-- Waiting Room -->
            <div id="waiting-room" class="hidden">
                <div class="room-header">
                    <h3>Room Code</h3>
                    <div id="room-code-display"></div>
                    <button id="copy-code-btn" class="copy-btn" title="Copy code">Copy</button>
                </div>

                <div id="player-slots">
                    <div class="team-column" data-team="0">
                        <div class="team-label">Team A</div>
                        <div class="player-slot" data-position="0" data-team="0">
                            <span class="slot-status">Waiting...</span>
                            <span class="slot-name"></span>
                            <span class="slot-ready"></span>
                            <button class="swap-btn hidden" title="Move to Team B">→</button>
                        </div>
                        <div class="player-slot" data-position="2" data-team="0">
                            <span class="slot-status">Waiting...</span>
                            <span class="slot-name"></span>
                            <span class="slot-ready"></span>
                            <button class="swap-btn hidden" title="Move to Team B">→</button>
                        </div>
                    </div>
                    <div class="team-column" data-team="1">
                        <div class="team-label">Team B</div>
                        <div class="player-slot" data-position="1" data-team="1">
                            <button class="swap-btn hidden" title="Move to Team A">←</button>
                            <span class="slot-status">Waiting...</span>
                            <span class="slot-name"></span>
                            <span class="slot-ready"></span>
                        </div>
                        <div class="player-slot" data-position="3" data-team="1">
                            <button class="swap-btn hidden" title="Move to Team A">←</button>
                            <span class="slot-status">Waiting...</span>
                            <span class="slot-name"></span>
                            <span class="slot-ready"></span>
                        </div>
                    </div>
                </div>

                <p id="host-team-hint" class="host-hint hidden">As host, click arrows to move players between teams</p>

                <div id="waiting-room-actions">
                    <button id="ready-btn" class="lobby-btn">Ready</button>
                    <button id="start-game-btn" class="lobby-btn primary hidden">Start Game</button>
                    <button id="leave-room-btn" class="lobby-btn secondary">Leave Room</button>
                </div>

                <div id="connection-status">
                    <span class="status-dot"></span>
                    <span class="status-text">Connected</span>
                </div>
            </div>

            <!-- Name Input Modal -->
            <div id="name-input-modal" class="hidden">
                <h3>Enter Your Name</h3>
                <input type="text" id="player-name-input" placeholder="Your name" maxlength="12" autocomplete="off">
                <div class="modal-actions">
                    <button id="name-cancel-btn" class="lobby-btn secondary">Cancel</button>
                    <button id="name-confirm-btn" class="lobby-btn primary">Confirm</button>
                </div>
            </div>

            <!-- Error Display -->
            <div id="lobby-error" class="hidden"></div>
        </div>
    </div>

    <!-- Multiplayer Status Bar (shown during game) -->
    <div id="multiplayer-status" class="hidden">
        <span id="mp-room-code"></span>
        <span id="mp-turn-indicator"></span>
        <button id="mp-leave-btn" class="mp-btn">Leave</button>
    </div>

    <!-- Rotate Device Overlay (portrait mode on mobile) -->
    <div id="rotate-overlay">
        <div class="rotate-content">
            <div class="rotate-icon">
                <svg viewBox="0 0 100 100" width="80" height="80">
                    <rect x="25" y="10" width="50" height="80" rx="5" fill="none" stroke="#40E0D0" stroke-width="3"/>
                    <circle cx="50" cy="80" r="4" fill="#40E0D0"/>
                    <path d="M75 50 L90 50 L82.5 35 Z" fill="#FFD700"/>
                    <path d="M90 50 Q95 50 95 55 L95 75 Q95 80 90 80 L75 80" fill="none" stroke="#FFD700" stroke-width="3"/>
                </svg>
            </div>
            <h2>Rotate Your Device</h2>
            <p>Dhiha Ei is best played in landscape mode</p>
        </div>
    </div>

    <!-- Install PWA Prompt -->
    <div id="install-prompt" class="hidden">
        <div class="install-content">
            <span>Install Dhiha Ei for the best experience</span>
            <button id="install-btn" class="install-btn">Install</button>
            <button id="install-dismiss" class="install-dismiss">&times;</button>
        </div>
    </div>

    <!-- Single bundled script (no modules) -->
    <script src="js/bundle.js"></script>

    <!-- PWA Install Handler -->
    <script>
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Show install prompt after a delay
            setTimeout(() => {
                const prompt = document.getElementById('install-prompt');
                if (prompt && !localStorage.getItem('pwaInstallDismissed')) {
                    prompt.classList.remove('hidden');
                }
            }, 3000);
        });

        document.getElementById('install-btn')?.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('Install prompt outcome:', outcome);
                deferredPrompt = null;
            }
            document.getElementById('install-prompt')?.classList.add('hidden');
        });

        document.getElementById('install-dismiss')?.addEventListener('click', () => {
            document.getElementById('install-prompt')?.classList.add('hidden');
            localStorage.setItem('pwaInstallDismissed', 'true');
        });

        // Hide install prompt if already installed
        if (window.matchMedia('(display-mode: standalone)').matches) {
            const prompt = document.getElementById('install-prompt');
            if (prompt) prompt.classList.add('hidden');
        }
    </script>
</body>
</html>
